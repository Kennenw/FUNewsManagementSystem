@model ListViewModel<CategoryViewModel>

@{
    ViewData["Title"] = "Category";
    var allCategories = ViewBag.AllCategories as List<CategoryViewModel>;
    // dùng để chuyển danh sách các danh mục(List<CategoryViewModel>) thành một từ điển(Dictionary<int, string>)
    var categoryMap = allCategories?.ToDictionary(c => c.CategoryId, c => c.CategoryName) ?? new Dictionary<int, string>();
}

<h1>Category</h1>
<a asp-action="Create" class="btn btn-success mb-3">Create New Category</a>
<form asp-action="Index" method="get" class="mb-3">
    <div class="input-group">
        <input type="text" name="searchQuery" value="@Model.SearchQuery" class="form-control" placeholder="Search by category name" />
        <button type="submit" class="btn btn-primary">Search</button>
    </div>
    <input type="hidden" name="sortBy" value="@Model.SortBy" />
    <input type="hidden" name="sortOrder" value="@Model.SortOrder" />
    <input type="hidden" name="pageNumber" value="@Model.PageNumber" />
    <input type="hidden" name="pageSize" value="@Model.PageSize" />
</form>

<div class="mb-3">
    <label>Sort by:</label>
    <a asp-action="Index" asp-all-route-data="@(new Dictionary<string, string> {
        { "searchQuery", Model.SearchQuery },
        { "sortBy", "CategoryId" },
        { "sortOrder", Model.SortBy == "CategoryId" && Model.SortOrder == "asc" ? "desc" : "asc" },
        { "pageNumber", "1" },
        { "pageSize", Model.PageSize.ToString() }
    })" class="btn btn-link">
        ID @(Model.SortBy == "CategoryId" ? (Model.SortOrder == "asc" ? "↑" : "↓") : "")
    </a>
    <a asp-action="Index" asp-all-route-data="@(new Dictionary<string, string> {
        { "searchQuery", Model.SearchQuery },
        { "sortBy", "CategoryName" },
        { "sortOrder", Model.SortBy == "CategoryName" && Model.SortOrder == "asc" ? "desc" : "asc" },
        { "pageNumber", "1" },
        { "pageSize", Model.PageSize.ToString() }
    })" class="btn btn-link">
        Name @(Model.SortBy == "CategoryName" ? (Model.SortOrder == "asc" ? "↑" : "↓") : "")
    </a>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Id</th>
            <th>Category Name</th>
            <th>Description</th>
            <th>Parent</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.Item)
        {
            <tr>
                <td>@item.CategoryId</td>
                <td>@item.CategoryName</td>
                <td>@item.CategoryDesciption</td>
                <td>
                    @(
                        item.ParentCategoryId.HasValue && categoryMap.ContainsKey(item.ParentCategoryId.Value)
                        ? categoryMap[item.ParentCategoryId.Value]
                        : "None"
                        )
                </td>
                <td>
                    <a asp-action="Edit" asp-route-id="@item.CategoryId" class="btn btn-primary btn-sm">Edit</a>
                    <button class="btn btn-danger btn-sm delete-btn" onclick="deleteCategory('@item.CategoryId')">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Pagination -->
<nav aria-label="Page navigation">
    <ul class="pagination">
        <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
            <a class="page-link" asp-action="Index" asp-all-route-data="@(new Dictionary<string, string> {
                { "searchQuery", Model.SearchQuery },
                { "sortBy", Model.SortBy },
                { "sortOrder", Model.SortOrder },
                { "pageNumber", (Model.PageNumber - 1).ToString() },
                { "pageSize", Model.PageSize.ToString() }
            })">Previous</a>
        </li>
        @for (var i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                <a class="page-link" asp-action="Index" asp-all-route-data="@(new Dictionary<string, string> {
                    { "searchQuery", Model.SearchQuery },
                    { "sortBy", Model.SortBy },
                    { "sortOrder", Model.SortOrder },
                    { "pageNumber", i.ToString() },
                    { "pageSize", Model.PageSize.ToString() }
                })">@i</a>
            </li>
        }
        <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
            <a class="page-link" asp-action="Index" asp-all-route-data="@(new Dictionary<string, string> {
                { "searchQuery", Model.SearchQuery },
                { "sortBy", Model.SortBy },
                { "sortOrder", Model.SortOrder },
                { "pageNumber", (Model.PageNumber + 1).ToString() },
                { "pageSize", Model.PageSize.ToString() }
            })">Next</a>
        </li>
    </ul>
</nav>

@if (!string.IsNullOrEmpty(ViewBag.Error))
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}

<script>
    async function deleteCategory(id) {
        if (!confirm('Are you sure you want to delete this category?')) return;

        const response = await fetch(`/Category/Delete/${id}`, {
            method: 'POST'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert("Xóa thất bại.");
        }
    }
</script>
